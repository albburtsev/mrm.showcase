/**
 * mrm.showcase -- Mail.Ru Maps traffic showcase
 * @author Alexander Burtsev, http://burtsev.me, 2014
 * @license MIT
 */
!function(a,b){"object"==typeof exports?module.exports=b():"function"==typeof define&&define.amd?define(b):a.Spinner=b()}(this,function(){"use strict";function a(a,b){var c,d=document.createElement(a||"div");for(c in b)d[c]=b[c];return d}function b(a){for(var b=1,c=arguments.length;c>b;b++)a.appendChild(arguments[b]);return a}function c(a,b,c,d){var e=["opacity",b,~~(100*a),c,d].join("-"),f=.01+c/d*100,g=Math.max(1-(1-a)/b*(100-f),a),h=j.substring(0,j.indexOf("Animation")).toLowerCase(),i=h&&"-"+h+"-"||"";return l[e]||(m.insertRule("@"+i+"keyframes "+e+"{0%{opacity:"+g+"}"+f+"%{opacity:"+a+"}"+(f+.01)+"%{opacity:1}"+(f+b)%100+"%{opacity:"+a+"}100%{opacity:"+g+"}}",m.cssRules.length),l[e]=1),e}function d(a,b){var c,d,e=a.style;for(b=b.charAt(0).toUpperCase()+b.slice(1),d=0;d<k.length;d++)if(c=k[d]+b,void 0!==e[c])return c;return void 0!==e[b]?b:void 0}function e(a,b){for(var c in b)a.style[d(a,c)||c]=b[c];return a}function f(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c)void 0===a[d]&&(a[d]=c[d])}return a}function g(a,b){return"string"==typeof a?a:a[b%a.length]}function h(a){this.opts=f(a||{},h.defaults,n)}function i(){function c(b,c){return a("<"+b+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',c)}m.addRule(".spin-vml","behavior:url(#default#VML)"),h.prototype.lines=function(a,d){function f(){return e(c("group",{coordsize:k+" "+k,coordorigin:-j+" "+-j}),{width:k,height:k})}function h(a,h,i){b(m,b(e(f(),{rotation:360/d.lines*a+"deg",left:~~h}),b(e(c("roundrect",{arcsize:d.corners}),{width:j,height:d.width,left:d.radius,top:-d.width>>1,filter:i}),c("fill",{color:g(d.color,a),opacity:d.opacity}),c("stroke",{opacity:0}))))}var i,j=d.length+d.width,k=2*j,l=2*-(d.width+d.length)+"px",m=e(f(),{position:"absolute",top:l,left:l});if(d.shadow)for(i=1;i<=d.lines;i++)h(i,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(i=1;i<=d.lines;i++)h(i);return b(a,m)},h.prototype.opacity=function(a,b,c,d){var e=a.firstChild;d=d.shadow&&d.lines||0,e&&b+d<e.childNodes.length&&(e=e.childNodes[b+d],e=e&&e.firstChild,e=e&&e.firstChild,e&&(e.opacity=c))}}var j,k=["webkit","Moz","ms","O"],l={},m=function(){var c=a("style",{type:"text/css"});return b(document.getElementsByTagName("head")[0],c),c.sheet||c.styleSheet}(),n={lines:12,length:7,width:5,radius:10,rotate:0,corners:1,color:"#000",direction:1,speed:1,trail:100,opacity:.25,fps:20,zIndex:2e9,className:"spinner",top:"50%",left:"50%",position:"absolute"};h.defaults={},f(h.prototype,{spin:function(b){this.stop();{var c=this,d=c.opts,f=c.el=e(a(0,{className:d.className}),{position:d.position,width:0,zIndex:d.zIndex});d.radius+d.length+d.width}if(b&&(b.insertBefore(f,b.firstChild||null),e(f,{left:d.left,top:d.top})),f.setAttribute("role","progressbar"),c.lines(f,c.opts),!j){var g,h=0,i=(d.lines-1)*(1-d.direction)/2,k=d.fps,l=k/d.speed,m=(1-d.opacity)/(l*d.trail/100),n=l/d.lines;!function o(){h++;for(var a=0;a<d.lines;a++)g=Math.max(1-(h+(d.lines-a)*n)%l*m,d.opacity),c.opacity(f,a*d.direction+i,g,d);c.timeout=c.el&&setTimeout(o,~~(1e3/k))}()}return c},stop:function(){var a=this.el;return a&&(clearTimeout(this.timeout),a.parentNode&&a.parentNode.removeChild(a),this.el=void 0),this},lines:function(d,f){function h(b,c){return e(a(),{position:"absolute",width:f.length+f.width+"px",height:f.width+"px",background:b,boxShadow:c,transformOrigin:"left",transform:"rotate("+~~(360/f.lines*k+f.rotate)+"deg) translate("+f.radius+"px,0)",borderRadius:(f.corners*f.width>>1)+"px"})}for(var i,k=0,l=(f.lines-1)*(1-f.direction)/2;k<f.lines;k++)i=e(a(),{position:"absolute",top:1+~(f.width/2)+"px",transform:f.hwaccel?"translate3d(0,0,0)":"",opacity:f.opacity,animation:j&&c(f.opacity,f.trail,l+k*f.direction,f.lines)+" "+1/f.speed+"s linear infinite"}),f.shadow&&b(i,e(h("#000","0 0 4px #000"),{top:"2px"})),b(d,b(i,h(g(f.color,k),"0 0 1px rgba(0,0,0,.1)")));return d},opacity:function(a,b,c){b<a.childNodes.length&&(a.childNodes[b].style.opacity=c)}});var o=e(a("group"),{behavior:"url(#default#VML)"});return!d(o,"transform")&&o.adj?i():j=d(o,"animation"),h}),!function(a){"use strict";var b=function(b,c){this.el=a(b),this.options=a.extend({},a.fn.typed.defaults,c),this.text=this.el.text(),this.typeSpeed=this.options.typeSpeed,this.startDelay=this.options.startDelay,this.backSpeed=this.options.backSpeed,this.backDelay=this.options.backDelay,this.strings=this.options.strings,this.strPos=0,this.arrayPos=0,this.string=this.strings[this.arrayPos],this.stopNum=0,this.loop=this.options.loop,this.loopCount=this.options.loopCount,this.curLoop=1,this.stopArray=this.loop===!1?this.strings.length-1:this.strings.length,this.build()};b.prototype={constructor:b,init:function(){var a=this;setTimeout(function(){a.typewrite(a.string,a.strPos)},a.startDelay)},build:function(){this.el.after('<span id="typed-cursor">|</span>'),this.init()},typewrite:function(a,b){var c=Math.round(70*Math.random())+this.typeSpeed,d=this;setTimeout(function(){if(d.arrayPos<d.strings.length){if("^"===a.substr(b,1)){var c=a.substr(b+1).indexOf(" "),e=a.substr(b+1,c);a=a.replace("^"+e,"")}else var e=0;setTimeout(function(){if(d.el.text(d.text+a.substr(0,b)),b>a.length&&d.arrayPos<d.stopArray){clearTimeout(c);var c=setTimeout(function(){d.backspace(a,b)},d.backDelay)}else if(b++,d.typewrite(a,b),d.loop===!1&&d.arrayPos===d.stopArray&&b===a.length){var c=d.options.callback();clearTimeout(c)}},e)}else d.loop===!0&&d.loopCount===!1?(d.arrayPos=0,d.init()):d.loopCount!==!1&&d.curLoop<d.loopCount&&(d.arrayPos=0,d.curLoop=d.curLoop+1,d.init())},c)},backspace:function(a,b){var c=Math.round(70*Math.random())+this.backSpeed,d=this;setTimeout(function(){if(d.el.text(d.text+a.substr(0,b)),b>d.stopNum)b--,d.backspace(a,b);else if(b<=d.stopNum){clearTimeout(c);var c=d.arrayPos=d.arrayPos+1;d.typewrite(d.strings[d.arrayPos],b)}},c)}},a.fn.typed=function(c){return this.each(function(){var d=a(this),e=d.data("typed"),f="object"==typeof c&&c;e||d.data("typed",e=new b(this,f)),"string"==typeof c&&e[c]()})},a.fn.typed.defaults={strings:["These are the default values...","You know what you should do?","Use your own!","Have a great day!"],typeSpeed:0,startDelay:0,backSpeed:0,backDelay:500,loop:!1,loopCount:!1,callback:function(){}}}(window.jQuery),jQuery(function(a){"use strict";function b(b,c,f){var g=p[b];g&&g.directions[f]&&(q.push({key:b,route:c,direction:g.directions[f]}),e.trigger("getroute.showcase")),g.polyline||(g.polyline=mrm.polyline(d.invertCoords(c.points),{weight:10,opacity:1,lineCap:"round",lineJoin:"bevel",className:"path inactive"}).addTo(r),a(".path.inactive").each(function(){var b=a(this);b.focus().blur().attr("class",b.attr("class").replace("inactive",""))}))}function c(){a("#typed-cursor").remove()}var d={inflect:function(a,b){var c,d=(a=parseInt(a,10))%10,e=a%100;return c=1==d&&11!=e?0:d>=2&&4>=d&&1!=Math.floor(e/10)?1:2,b[c]},invertCoords:function(a){for(var b,c=0,d=[];c<a.length;c++){b=a[c];for(var e,f=0;f<b.length;f++)e=b[f],d.push([e[1],e[0]])}return d},scoreColor:function(a){return a=parseInt(a),a=Math.min(a,10),a=Math.max(a,0),4>=a?"green":7>=a?"yellow":"red"}},e=a(window),f=a(".js-map"),g=a("body"),h=a(".js-sidebar-head"),i=a(".js-sidebar-score"),j=_.template(a("#tpl_title").html()),k=_.template(a("#tpl_score").html()),l="is-loading",m="is-short",n=!1,o=null,p={},q=[];a.ajaxSetup({dataType:"json",cache:!1}),e.on("getroute.showcase",function(){n||(n=!0,o=q.shift(),e.trigger("opentitle.showcase"))}),e.on("opentitle.showcase",function(){var b=a(j()),d=(a(k({color:o.route.tag})),a(".js-typed",b)),e="^2000 "+o.direction.title+" â€“ ";b.appendTo(g).focus().blur().removeClass(m).one("transitionend",function(){d.typed({strings:[e],callback:function(){console.log("callback #1"),c()}})})}),e.on("init.showcase",function(){for(var c in p)for(var d,e=p[c],f=e.directions,g=f.length;g--;)d=f[g],a.ajax("http://maps.mail.ru/mroutes",{key:c,idx:g,data:{wtype:1,points:d.points.join(",")},success:function(a){b(this.key,a,this.idx)}})}),e.on("score.showcase",function(a,b){var c=d.scoreColor(b),f=i.data(),g=f.forms.split(","),j=f.classPrefix;i.removeClass(["","red","yellow","green"].join(" "+j)).addClass(j+c).html(b+" "+d.inflect(b,g)),h.on("transitionend",function(){e.trigger("getconfig.showcase")}).removeClass(l)}),e.on("getconfig.showcase",function(){a.get("static/js/config.json",function(a){p=a,e.trigger("init.showcase")})}),e.on("mapinit.showcase",function(){var b=window.mailru||{};b.maps=b.maps||{},window.mailru=b,b.maps.cityjams=function(a){var b="77";a=a||{},a=a[b],a&&void 0!==a.score&&e.trigger("score.showcase",a.score)},a.getScript("http://maps.mail.ru/jams/jams.jsonp")});var r=mrm.map(f.get(0),{dragging:!1,touchZoom:!1,scrollWheelZoom:!1,doubleClickZoom:!1,boxZoom:!1});r.removeLayer(r.__layerSchema),r.removeControl(r.copyrightControl),r.removeControl(r.logoControl);var s=L.tileLayer("http://t{s}maps.mail.ru/tiles/scheme/{z}/{y}/{x}.png",{subdomains:"0123456789"}).addTo(r);s.on("load",function(){e.trigger("mapinit.showcase")}),window.map=r,a(".spinner").each(function(){var b=a(this),c=Math.min(b.width(),b.height());new Spinner({length:c/7,radius:c/7,width:c/20,className:"spinner__inner"}).spin(this)})});